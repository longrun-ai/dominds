# ws_mod Error Handling

## Template (Errors)
### Error Chain (required)
1) Trigger Condition
2) Detection Signal
3) Recovery Steps
4) Success Criteria
5) Escalation Path (optional)

## Error Classification

| Stage   | Error Code                | Description                             | Solution                                                           |
| ------- | ------------------------- | --------------------------------------- | ------------------------------------------------------------------ |
| prepare | `FILE_NOT_FOUND`          | File does not exist                     | Use `create=true` parameter or create file first                   |
| prepare | `CONTENT_REQUIRED`        | Content empty but tool requires content | Provide `content` for insert/append/block_replace                  |
| prepare | `ANCHOR_NOT_FOUND`        | Anchor line not found                   | Check anchor text correctness, or use `ripgrep_snippets` to locate |
| prepare | `ANCHOR_AMBIGUOUS`        | Anchor has multiple matches             | Specify `occurrence` parameter to identify which match             |
| prepare | `OCCURRENCE_OUT_OF_RANGE` | occurrence out of range                 | Check if occurrence value is within `1~candidates_count` range     |
| apply   | `HUNK_NOT_FOUND`          | Hunk expired/applied/does not exist     | Re-run prepare to generate new hunk                                |
| apply   | `WRONG_OWNER`             | Hunk planned by different member        | Hunk must be generated by current member                           |
| apply   | `FILE_NOT_FOUND`          | File does not exist at apply time       | Check if file was deleted or moved                                 |
| apply   | `CONTEXT_REJECTED`        | File drifted, cannot safely apply       | Re-run prepare                                                     |
| write   | `PERMISSION_DENIED`       | No write permission                     | Check path permissions                                             |
| write   | `FILE_EXISTS`             | File already exists (create_new_file)   | Use different path or delete existing file first                   |

## Common Error Scenarios & Troubleshooting

### 1. Anchor-Related Errors

**ANCHOR_NOT_FOUND**

- Cause: Anchor text does not exist in file
- Troubleshooting: Use `ripgrep_snippets` to confirm anchor exists
- Note: Anchor matching is case-sensitive unless using `match: "contains"` (default)

**ANCHOR_AMBIGUOUS**

- Cause: Anchor appears multiple times in file
- Troubleshooting: Use `ripgrep_snippets` to see all match positions
- Solution: Add `occurrence` parameter (e.g., `occurrence: 2` for second match)

**OCCURRENCE_OUT_OF_RANGE**

- Cause: Specified occurrence greater than actual match count
- Solution: Change occurrence value to a valid range number

### 2. Hunk-Related Errors

**HUNK_NOT_FOUND**

- Cause 1: Hunk expired (TTL=1h)
- Cause 2: Process restarted, hunk in memory lost
- Solution: Re-run prepare to generate new hunk

**WRONG_OWNER**

- Cause: Trying to apply someone else's hunk
- Solution: Can only apply hunks generated by yourself

**CONTEXT_REJECTED**

- Cause: File modified after prepare, anchor positions changed
- Solution: Re-run prepare

### 3. Content Format Errors

**Default Reject Diff/Patch**

- Cause: Using `overwrite_entire_file`, body looks like diff/patch format but not declared
- Solution:
  - Option 1: Use `prepare_*` + `apply_file_modification`
  - Option 2: Explicitly declare `content_format: "diff"` or `content_format: "patch"`

### 4. Permission Errors

**PERMISSION_DENIED**

- Cause: No write permission to target path
- Solution: Check file/directory permission settings

### 5. Path Errors

**FILE_NOT_FOUND**

- Cause: File path does not exist
- Solution:
  - If appending: use `create: true` parameter
  - Other cases: Create file first or check if path is correct

## Error Prevention Tips

1. **prepare â†’ apply must be two messages**: Parallel execution in same message may cause apply to not see hunk

2. **Read before write**: Call `read_file` first to get old file snapshot before using `overwrite_entire_file`

3. **Use unique anchors**: Avoid using too generic text as anchors; use `occurrence` to be explicit when needed

4. **Apply promptly**: Hunks have 1 hour TTL, apply as soon as possible after generation

5. **Check output fields**: Especially `normalized.*` fields to confirm write behavior is as expected
