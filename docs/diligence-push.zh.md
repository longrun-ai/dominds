# Diligence Push（鞭策）— 设计文档

## 概述

Dominds 根对话旨在长期运行。根对话"停止"（变为空闲）通常不是操作员想要的：他们希望智能体持续推进，直到：

- 合法地暂停等待人类决策（Q4H），或
- 合法地暂停等待子对话（tellask/backfill）。

本文档指定了一个运行时机制（"diligence-push"），仅针对**根/主对话**，防止对话停止：每当驱动程序即将停止时，它会自动发送一个简短的鞭策语（渲染为正常的用户气泡）并继续生成，除非对话处于合法暂停状态（Q4H 或待处理的子对话）。

## 目标

- 防止根对话停止，除非处于合法暂停状态（Q4H / 子对话）。
- 保持行为可预测和有界（无无限循环）。
- 使鞭策语文本可按工作区（rtws）和语言配置。
- 提供清晰的用户控制的"禁用"机制。

## 非目标

- 自动完成/自动将对话标记为完成。
- 将此行为应用于子对话（子对话保持范围，应向其调用者报告）。

## 定义

- **根/主对话**：`RootDialog`（`dlg.id.rootId === dlg.id.selfId`），主要对话线程。
- **子对话**：`SubDialog`，为 tellask / 作用域工作创建。
- **Q4H**："Questions for Human"，通过 `!?@human` 发起，暂停对话进度直到人类响应。

## 预期的"正常"完成路径（推荐）

当智能体需要人类决策来结束时（例如，确认选择或决定是否将对话标记为完成），正确的路径是：

1. 智能体发出 Q4H（`!?@human`）并提供必要的上下文和明确的决策请求。
2. WebUI 清楚地呈现 Q4H。
3. 人类决定并：
   - 手动将根对话标记为"完成"，或
   - 提供请求的信息以便对话继续。

这是"受控收敛"路径。diligence-push 机制不应覆盖合法的暂停状态。

## Diligence Push 行为（"自动继续"回退）

### 触发条件（必须全部满足）

- 对话是**根/主对话**（绝不会是子对话）。
- 对话**未暂停**：
  - 没有待处理的 Q4H，并且
  - 没有待处理的子对话（等待回填）。
- 驱动程序即将停止生成循环（即没有工具/函数输出需要另一次迭代）。

### 操作

运行时自动发送一个鞭策语（渲染为正常的用户气泡）并运行另一次生成迭代。

### 有界性

为避免无限循环，diligence-push 有一个按对话的预算（每个成员的 `diligence-push-max`），控制对于给定对话在运行时强制 Q4H 暂停之前可以注入多少个自动继续的鞭策语。

- 默认值：**3**
- 如果 `< 1`，则该成员的 diligence-push 有效禁用
- 可通过 `.minds/team.yaml` 中的 `diligence-push-max` 按成员配置

### Q4H 时重置

当对话因待处理的 Q4H（Questions for Human）而暂停时，diligence-push 注入计数器会被重置。这确保在人类回答 Q4H 并恢复对话后，对话会获得新的 diligence-push 预算。

### 预算耗尽 → 强制 Q4H

当 diligence-push 预算耗尽时，运行时会创建一个 Q4H 条目，询问人类是否继续或停止。这将"有界性"转换为合法的暂停点，并避免无限自动继续循环。

### 禁用开关

可以通过以下任一方式按 rtws 禁用 diligence-push：

- 如果选中的鞭策语文件存在但其内容为空/仅空白，则禁用 diligence-push（不注入）。

可以通过以下任一方式按成员禁用 diligence-push：

- 如果 `diligence-push-max < 1`，则该成员的 diligence-push 被禁用（不注入）。

## 鞭策语解析

让 `<rtws>` 为当前运行时工作区（即 `process.cwd()`）。

解析顺序：

1. `<rtws>/.minds/diligence.<work-lang-id>.md`（例如，`diligence.zh.md`）
2. `<rtws>/.minds/diligence.md`（语言无关的回退）
3. 内置回退文本（硬编码的 i18n；`zh` 是规范的并嵌入在源代码中）

如果上述顺序中第一个存在的文件具有空/空白内容，则**禁用** diligence-push。

注意：鞭策语文件中的 YAML frontmatter 会被运行时忽略。如果存在，它被视为非内容元数据并从提示正文中剥离。

### 团队成员上限：`diligence-push-max`

每个团队成员可以选择通过 `.minds/team.yaml` 限制 diligence-push：

```yaml
members:
  alice:
    diligence-push-max: 10
```

规则：

- 如果缺失，`diligence-push-max` 对于该成员默认为 **3**。
- 如果 `diligence-push-max < 1`，则该成员的 diligence-push 被禁用（不注入），即使鞭策语文件存在。
- 内置影子成员 `fuxi` 和 `pangu` 默认为 `diligence-push-max: 0`，除非在 team.yaml 中显式覆盖。

## UX 备注

- Diligence-push 是一个仅运行时的提示，但它应该是**可见的**：鞭策语渲染为正常的用户消息气泡（由运行时自动发送），以便操作员理解为什么会出现额外的迭代。
- 用户应该观察到智能体在仅工具操作后继续简短的跟进。
- 当智能体真正需要用户干预时，它应该使用 Q4H。Diligence-push 不应试图"假装"完成。

## 实现（后端）

### 位置

在 LLM 驱动程序循环中实现（`dominds/main/llm/driver.ts`），作为迭代后的小检查：

1. 如果 `suspendForHuman` 为 true，则停止（Q4H / 子对话待处理）。
2. 如果有任何工具反馈，则正常继续。
3. 否则（仅限根），尝试 diligence-push 自动继续：
   - 如果禁用 → 正常停止。
   - 如果预算耗尽 → 创建 Q4H 并停止。
   - 否则 → 自动发送鞭策语并继续。

### 消息类型

我们将鞭策语作为自动发送的用户消息注入：

- 类型为 `prompting_msg`、角色为 `'user'` 的 `ChatMessage`

这确保了：

- 它存在于模型上下文中
- 它作为人类消息记录持久化
- 它在聊天时间线中渲染为正常的用户气泡（像任何其他用户消息一样）

## 可观察性

建议的后续步骤（初始实现不需要）：

- 当触发 diligence-push 时添加结构化日志行，包括：
  - 对话 id
  - 语言
  - 使用的鞭策语来源（语言特定/通用/内置/禁用）
- 为"diligence-push 触发"和"diligence-push 因空文件禁用"添加可选的指标计数器。

## 测试

回归测试应覆盖：

- 根对话：仅工具输出 → 鞭策语注入 → 继续响应
- 根对话：空助手输出 → 鞭策语注入 → 继续响应
- 子对话：无鞭策语注入
- 工作区配置：
  - 当语言特定文件缺失时，`.minds/diligence.md` 被遵守
  - 空的鞭策语文件禁用 diligence-push
