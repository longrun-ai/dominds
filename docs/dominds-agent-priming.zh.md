# Dominds 智能体启动（Priming）：引导祂做给自己看

英文版：[English](./dominds-agent-priming.md)

## 摘要

Dominds 的诉请（Tellask，`!?@...`）与扪心自问（FBR，`!?@self`）并不是“写在系统提示里的约定”，而是**后端真实可驱动、可执行、可回传、可持久化**的机制。

问题在于：即使系统提示把这些机制写得再细，大多数基础模型也并未在“真的可以随时拉一个队友去跑 shell 命令并把结果带回来”的世界里被训练过，因此容易把提示当成“说说而已 / 仅供参考”。这会直接削弱诉请与 FBR 的可用性。

因此引入 **智能体启动（Agent Priming）**：在一个对话创建之初，运行一段极短、极拟真的“真实诉请 + 真实回传 + 真实 FBR + 真实综合提炼”，让智能体产生明确的体感。

更贴切地说，这是在**引导祂做给自己看**：让智能体亲身走一遍（诉请→回传→FBR→综合提炼），从“听说有这个机制”变成“我刚刚用过它”。

这与心理学的**启动效应（priming effect）**在“机制形态”上相似：一次早期、具体、可感的刺激，会显著影响后续的期待与行为模式。在 Dominds 里，我们把这种“启动”落在**可验证的真实交互**上，而不是落在更长更复杂的宣告式系统提示上。

体感建立后，系统提示可以**大幅简化**：只保留“短而准确”的契约说明即可，把“这在本环境里真实可用”的可信度交给一次真实启动来完成。

相关文档：

- 诉请机制与对话系统：[`dialog-system.zh.md`](./dialog-system.zh.md)
- 术语约定（主线/支线；诉请方/应答方）：[`dominds-terminology.md`](./dominds-terminology.md)
- FBR（`!?@self`）：[`fbr.zh.md`](./fbr.zh.md)
- 工作语言 vs UI 语言：[`i18n.zh.md`](./i18n.zh.md)

---

## 目标

- 在对话一开始就建立“诉请/回传/持久化都是真的”的信任。
- 在对话一开始就跑通一次 `!?@self` 的 FBR 回路。
- 把多份 FBR 草稿做一次**综合提炼**，把“取精华、去糟粕”的动作也变成体感的一部分。
- 过程足够小、可控、低风险（默认只执行 `uname -a`）。
- 记录从多角度都高度拟真：后端存档 + 前端可见的对话转录。

## 非目标

- 不在创建对话时执行任意用户输入的命令。
- 不收集敏感信息（默认只采集最小的 OS/Kernel 识别信息）。
- 不替代系统提示/设计文档：这是“启动与体感补强”，不是完整规范的主载体。

---

## 概念（用户视角）

- **主线对话**：用户与主要智能体交互的那条线。
- **支线对话**：由诉请 / FBR 触发的临时工作线，产出结果回传主线。
- **诉请（Tellask）**：以 `!?@<memberId> ...` 向队友/对话发起的结构化请求。
- **Shell 专员（shell specialist）**：被允许执行 shell 命令并回传结果的队友（由 `shell_specialists` 配置指定）。
- **FBR（扪心自问）**：以 `!?@self` 触发的“无工具支线推理”，产出报告回传主线。

---

## 运行流程（对话创建时）

智能体启动发生在**第一条用户消息被处理之前**，除非用户在创建对话时明确选择跳过。

### 1）选择执行路径

1. 如果 team 配置里存在 `shell_specialists`，选择一个 shell 专员（建议确定性选择：列表第一个）。
2. 否则，由 **Dominds 运行时**直接执行基线命令（不通过智能体工具）。

基线命令（默认）：

- `uname -a`

`uname -a` 失败时（例如非 POSIX 环境），可以改用平台等价命令；但默认肌肉记忆路径保留 `uname -a`，因为它低风险、快、且信息量刚好够用。

### 2）真实队友诉请：让 shell 专员执行 `uname -a`

若存在 shell 专员，则主线智能体（诉请方）以**工作语言**向 shell 专员（应答方）发起真实诉请，要求：

- 执行 `uname -a`（只执行这一条）
- 原样返回输出（不要改写/解释）
- 若命令不可用/失败：返回错误信息，并给出一个安全的替代命令

结果必须以正常对话转录的方式落盘并展示，至少清晰体现：

- 诉请的 headline + body
- shell 专员实际执行了命令
- 返回的原始输出

### 3）真实 FBR：基于环境信息做一次“扪心自问”

拿到环境快照后，主线智能体触发一次 `!?@self` FBR，并在 FBR 的诉请正文里带上：

- 命令 `uname -a` 的完整输出（明确注明命令名，未来可能更换命令，不能靠猜）
- FBR 的工具约束（FBR 无工具；主线工具另论）
- 问题：在这个环境里要注意什么？优先用哪些命令行工具，为什么？

并发草稿（可选）：

- 若团队成员配置启用了 `fbr_effort`（默认值为 `3`），运行时会并发创建多份 `!?@self` FBR 支线对话，让“初心自我”从不同角度独立推理，形成多份草稿供主线对话综合提炼。
- 这些草稿之间**没有稳定身份映射**，也没有必须遵循的先后顺序；主线对话应当把它们当作“多份匿名草稿”，而不是“固定的三个角色”。
- 若 `fbr_effort` 为 `0`，则跳过 FBR。
- 若 `fbr_effort` 大于 `100`，运行时会报错并终止启动流程（配置错误）。

### 4）综合提炼成“智能体启动（Priming）”笔记

主线智能体以一次**正常生成**在主线对话里追加一条短笔记（Agent Priming），让关键信息显性化、可检索，并体现“综合提炼”（去重/消冲突/抽取最有用的要点）。

实现约束（与运行时一致）：

- “综合提炼”阶段**不应**通过拼装/拼接一段“专用综合提示词”去喂给模型。
- 运行时应当保持与正常对话完全一致：FBR 支线对话把回复回传给主线后，由标准 driver 的“支线回复注入”机制把这些回复作为新的用户上下文注入主线，再触发一次正常生成完成综合提炼。

---

## 持久化、缓存与复用（仅进程内）

### 1）记录必须“像真的一样”

智能体启动的每一步都必须作为标准对话记录落盘（消息 + 事件），并在 WebUI 中可见：

- 可 debug（日志/存储都有迹可循）
- 可回放（对话历史导航时不丢信息）

### 2）按智能体维度进程内缓存

为避免每次新对话都重复跑 `uname -a` + FBR + 综合提炼，后端进程维护一个**进程内缓存**（重启失效），按主线智能体 id 做 key。

复用策略：

- 若命中缓存，新对话可直接复用首次的转录与“Agent Priming”笔记，不再重复执行。
- 复用的记录在新对话里仍应可见，并清楚标记“来自缓存复用”。

### 3）跨 `clear_mind` 携带

每次 `clear_mind` 进入下一程时，不要依赖 reminder 来承载这件事。

改为：在每一程对话的上下文里注入一段小而稳定的 **course prefix**（可理解为“历史消息区最开头的几条 msg”），内容是从首次启动中提炼出的压缩转录（shell 快照 + FBR 摘要 + Priming 笔记）。这样智能体能持续保留“体感”和环境约束，而无需重复执行启动流程。

---

## WebUI 需求

### 展示

- 智能体启动应以真实对话转录展示，用户可展开查看细节。
- 建议在对话顶部提供一个可折叠区域，并带上清晰标签：
  - “队友诉请（shell）”
  - “FBR（`!?@self`）”
  - “智能体启动（Agent Priming）”

### 创建对话时可选择跳过（opt-out）

创建对话框上提供明确开关，跳过这一安排（不执行启动流程，也不生成启动转录）。

补充约定：

- 当对话主理人选择为（隐藏的）影子智能体时，“智能体启动（Priming）”选项默认应为“无感”。
- 影子智能体的“启动”选项应与显在智能体的“启动”选项分开记忆（互不影响）。

---

## 安全注意事项

- 默认只执行 `uname -a`（低风险、只读、快）。
- 启动阶段禁止任何会改写文件/网络/系统状态的操作。
- 由于启动默认用户可见，严禁输出密钥/敏感信息。
