# 扪心自问（FBR）——设计文档（增强版 `@self`）

英文版：[English](./fbr.md)

## 摘要

扪心自问（FBR）是 Dominds 的常用工作模式：智能体向自己发起自诉请（`!?@self`），创建一个短生命周期的支线对话，让“初心版本的自己”围绕一个边界清晰的子问题做推理，再把结论回贴给诉请者。

本文档定义对 `@self` 发起的 FBR 做专项增强：

1. **无工具 FBR 支线对话**：由 `!?@self` 产生的 FBR 支线对话必须是“无工具”的，不得拥有任何工具/工具集。系统提示 / 工具提示必须明确说明：被诉请者**没有工具**，只能基于诉请正文做推理与总结。
2. **可配置的 FBR 并发**：在 `.minds/team.yaml` 增加 `fbr-effort`（默认 `3`；“三个臭皮匠，顶个诸葛亮”）：
   - `0` 禁用该队友的 `!?@self` FBR
   - `1..100` 表示每次 `!?@self` 会并发创建这么多个 FBR 支线对话
   - `> 100` 视为配置错误（直接报错）
3. **FBR 专用模型参数覆盖**：在 `.minds/team.yaml` 增加 `fbr_model_params`，其格式与 `model_params` 完全相同（参考 `dominds/main/llm/defaults.yaml` 的 `model_param_options`）。目的：FBR 时可使用不同的模型参数（例如更高的 `temperature`），而不影响主线对话。
   - 注：通用的 `max_tokens` 允许写成顶层 `max_tokens`，也允许写成 `general.max_tokens`（与 `model_param_options` 的分组一致）；二选一即可，禁止同时设置。

## 目标

- 通过移除工具能力并要求诉请正文自给自足，让 `!?@self` FBR 更安全、更可预期。
- 支持“多样本推理”：通过并发创建多个 FBR 支线对话（`fbr-effort`）提升决策质量。
- 允许只在 FBR 场景调整模型参数，而不影响主线对话的整体行为风格。

## 非目标

- 不新增全新的用户语法：仍然只使用现有 `!?@self` / `!?@self !tellaskSession ...`。
- 不为 FBR 支线对话提供工具（本文档的核心就是“无工具”）。
- 不改写通用的队友诉请分类法（详见 [`dialog-system.zh.md`](./dialog-system.zh.md)）；本文档仅约束 `@self` FBR。

## 定义

- **扪心自问（FBR）**：从第一性原理出发，不依赖既有对话历史的推理方式。
- **诉请（Tellask）**：以 `!?@...` 形式对某个对话参与方（包括 `@self`）发起的结构化请求。
- **诉请者 / 被诉请者**：一次诉请中的请求方 / 应答方。
- **主线对话 / 支线对话**：对外用语，用于描述承载主要推进的对话线程及其临时工作线程。
  （实现语境中可能出现 `root/main/subdialog` 等术语；不要把这些实现术语写进用户可见提示词/示例。）

## 运行时行为：无工具 `!?@self` FBR

### 触发：哪些诉请算作 FBR

以下语法都视为 `@self` FBR：

- 默认（瞬态）：`!?@self`
- 少用（可恢复）：`!?@self !tellaskSession <tellaskSession>`（该支线对话会携带自身既有的 `tellaskSession` 历史）

本文档对两者一视同仁：**任何 `@self` FBR 支线对话都必须是无工具的**。

### 隔离约束

运行时在驱动由 `!?@self` 创建的 FBR 支线对话时，必须强制满足：

- **无工具**：
  - 不提供任何函数工具
  - 不提供任何 MCP 工具
  - 不允许发起任何队友诉请（包括 `!?@human`）；唯一例外：`!?@tellasker`（仅支线对话可用，用于回问上游诉请者对话），且当且仅当你需要澄清关键缺失上下文时才允许
- **不依赖诉请者线程上下文**：
  - 被诉请者不得假设能访问诉请者的主线/支线对话历史
  - 被诉请者必须把诉请正文当作主要且权威的任务上下文
  - 若使用 `!tellaskSession`（可恢复）形式，被诉请者可以使用**自身**既有的 `tellaskSession` 历史作为显式上下文
  - 被诉请者不得通过工具去读文件/浏览/跑命令，或获取 Memory / rtws（运行时工作区）状态

直觉上，可以把被诉请者理解为“相对诉请者线程是回到初心的”：它不会继承诉请者累积的对话历史；但它仍可能接收一些无条件注入的基础上下文（人设/系统规则/安全规范/格式规范/只读 Memory 摘要等）。当使用 `!tellaskSession` 形式时，该支线对话还会包含自身的会话历史。

### 提示词契约（系统提示 + 工具提示）

运行时必须让“无工具”约束在提示词中明确且无歧义。

### API / 传输层契约（强制禁用工具）

“无工具”不仅是提示词写法，运行时必须在技术上强制执行：

- 发起 `@self` FBR 支线对话的 LLM 请求必须做到 **0 个可用工具**：
  - 请求 payload 中不得包含任何 tool/function 定义（有效工具列表必须为空）
  - 不得启用提供方支持的任何“工具调用模式 / 工具选择 / 函数调用 开关”
- 即便提供方 SDK 默认会接受工具调用，运行时也必须拒绝 FBR 中模型发出的任何工具调用企图。

#### system prompt 的最低要求

FBR 支线对话的 system prompt 必须明确包含：

- 你**没有任何工具**，不能调用工具。
- 你不能直接访问 rtws（运行时工作区） / 文件 / 浏览器 / shell（工具调用已禁用）。
- 诉请正文是**主要任务上下文**；不要假设你能访问诉请者线程历史。
- 若这是可恢复的 `!tellaskSession` FBR，你可以使用**自身**既有的 `tellaskSession` 历史作为显式上下文。
- 若诉请正文缺少关键上下文，你需要列出缺失信息及其阻塞原因。
- 仅当你必须澄清关键缺失上下文时，允许 `!?@tellasker` 回问诉请者；除此之外不要发起任何诉请。

#### 工具提示的要求（如适用）

如果某个提供方集成通常会注入工具提示（或工具结构），那么对 `@self` FBR 必须二选一：

- 完全不注入工具提示，或
- 注入一个明确声明“没有工具可用/工具调用已禁用”的工具提示

无论如何，FBR 支线对话都不应看到任何工具定义。

### 输出契约

FBR 支线对话应产出一份便于诉请者整合的简明推理结果。推荐结构（不强制）：

1. **结论 / 建议**
2. **推理过程**（基于诉请正文；若是可恢复形式，可结合自身 `tellaskSession` 历史）
3. **前提假设**（应明确标注来源：诉请正文/会话历史）
4. **未知项 / 缺失上下文**
5. **下一步**（由诉请者在主线对话中执行；主线对话可能具备工具）

### 执行与错误处理

- 如果 FBR 支线对话尝试发出工具调用，运行时必须将其视为硬错误，并将清晰的错误信息回贴给诉请者（不得静默忽略）。
- 错误应当“响亮且可调试”（例如在日志/事件中携带明确的错误原因标识）。

## 配置：`.minds/team.yaml` 新增字段

两个新增字段都是**按队友**配置的；也可以放在 `member_defaults` 下作为全局默认。

### `fbr-effort`（默认：`3`）

`fbr-effort` 控制每次 `!?@self` 诉请要并发创建多少条无工具 FBR 支线对话。

规则：

- 类型：整数
- 默认：`3`（“三个臭皮匠，顶个诸葛亮”）
- `0`：禁用该队友的 `!?@self` FBR
- `1..100`：每次 `!?@self` 并发创建 N 条 FBR 支线对话
- `> 100`：配置错误（直接报错；不得自动截断）
- `< 0` 或非整数：配置错误

**禁用行为（`fbr-effort: 0`）**：

- 运行时必须拒绝该队友发起的 `!?@self`（对用户可见且清晰），避免“静默失效”。

### 并发语义（`fbr-effort > 1`）

当 `fbr-effort` 为 `N` 时：

- 运行时将一条 `!?@self` 扩展为 **N 条并行的无工具 FBR 支线对话**。
- 每条支线对话收到相同的诉请正文（以及相同的无工具系统提示 / 工具提示约束）。
- 运行时会把所有 N 条回贴注入回诉请者；**不要依赖任何固定顺序**（可能按完成先后顺序混合注入）。
- 对可恢复的 `!?@self !tellaskSession <tellaskSession>` 形式，若 `N > 1`，运行时必须派生出**不同的**
  会话 key，以确保每条并行支线对话的历史互不污染（推荐方案：`<tellaskSession>.fbr<i>`）。

该设计的意图是让诉请者（主线）能够综合多条独立推理轨迹，提炼共识并做出更稳健的决策。

### `fbr_model_params`（可选）

`fbr_model_params` 用于只在 `@self` FBR 支线对话驱动 LLM 时覆盖模型参数。

- 结构：与 `model_params` 完全一致（参考 `dominds/main/llm/defaults.yaml` 的 `model_param_options`）
- 作用域：仅对 `!?@self` FBR 支线对话生效
- 非 FBR 场景仍使用正常的 `model_params`

**合并规则（推荐）**：

- 先按常规规则计算队友的有效 `model_params`（defaults + overrides）。
- 仅在 `@self` FBR 场景下，把 `fbr_model_params` 深合并覆盖到其上（例如只覆盖 `temperature`）。

## 示例

### 无工具 FBR：诉请正文必须自给自足

反例（依赖外部上下文与工具）：

```text
!?@self
帮我找 bug 并修掉。
```

正例（上下文自足）：

```text
!?@self
你在做无工具的扪心自问（FBR）。只能使用下面这些文字作为上下文。

目标：解释最可能的根因，并给出 2~3 个修复方案。

现象：
- 点击 “Run” 有时会让 UI 卡住 ~10 秒。

约束：
- 不能改后端协议。

相关片段：
<把关键日志 / 代码 / 栈追踪粘贴在这里>
```

### `.minds/team.yaml` 配置示例

```yaml
member_defaults:
  # 默认每次 `!?@self` 并发创建 3 条无工具 FBR 支线对话（“三个臭皮匠，顶个诸葛亮”）。
  fbr-effort: 3

members:
  ux:
    # 每次 `!?@self` 并发创建 5 条独立的 FBR 支线对话。
    fbr-effort: 5

    # 让 FBR 更“发散”，但不影响主线对话。
    fbr_model_params:
      codex:
        temperature: 0.9
        reasoning_effort: medium
      general:
        max_tokens: 1200
```

## 兼容性说明

- 本规范刻意让 `!?@self` 与一般的瞬态支线对话行为不同：
  普通 `!?@<队友>` 的支线对话仍然是“全能力”的（可拥有工具/工具集），其行为以 [`dialog-system.zh.md`](./dialog-system.zh.md) 为准。
- 若你需要“同人设但可用工具”的“回到初心”的支线对话，应使用一个明确的队友身份并为其授予相应工具集，而不是使用 `@self`。

## 验收标准（实现检查清单）

- `!?@self` 创建的 FBR 支线对话在技术上不提供任何工具，且系统提示 / 工具提示明确声明“无工具 + 诉请正文为主上下文”。
- `fbr-effort` 默认 `3`；允许 `0..100`；`>100` 与非整数应报错。
- `fbr-effort: 0` 时 `!?@self` 必须清晰失败（不可静默忽略）。
- `fbr_model_params` 仅对 `@self` FBR 生效，且结构与 `model_params` 一致。
